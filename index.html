<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Webcam Mood Analyzer</title>
<style>
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    margin:0;background:#f4f6fa;color:#111;
    display:flex;flex-direction:row;flex-wrap:wrap;
    height:100vh;overflow:hidden;
  }
  #left,#right{padding:10px;}
  #left{flex:2;display:flex;flex-direction:column;align-items:center;justify-content:center;}
  #right{
    flex:1;background:#fff;border-left:2px solid #e5e7eb;
    overflow-y:auto;font-size:14px;
  }
  video,canvas{
    border-radius:10px;max-width:100%;
    box-shadow:0 4px 15px rgba(0,0,0,0.1);
  }
  #controls{
    margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;justify-content:center;
  }
  button{
    padding:8px 14px;border-radius:8px;border:1px solid #ccc;
    background:white;cursor:pointer;font-size:15px;
  }
  button[disabled]{opacity:.5;cursor:not-allowed}
  #status{margin-top:8px;font-size:14px;color:#444;text-align:center}
  .mood-pill{
    display:inline-block;padding:4px 8px;border-radius:20px;
    background:#eef2ff;border:1px solid #cdd8ff;margin:3px;
  }
  #mood-log{padding:10px;}
  #avg-table td,#avg-table th{padding:3px 6px;text-align:left;}
  #avg-table th{background:#f8fafc;}
  h3{margin:6px 0;}
</style>
</head>
<body>
  <div id="left">
    <h2>😀 Webcam Mood Analyzer</h2>
    <video id="video" autoplay muted playsinline width="640" height="480"></video>
    <canvas id="overlay" width="640" height="480"
            style="position:absolute;left:-9999px;"></canvas>
    <div id="controls">
      <button id="btnOpen">Open Camera</button>
      <button id="btnStart" disabled>Start</button>
      <button id="btnStop" disabled>Stop</button>
    </div>
    <div id="status">Waiting...</div>
  </div>

  <div id="right">
    <h3>Live Mood Log</h3>
    <div id="mood-log"></div>
    <h3>Average Moods</h3>
    <table id="avg-table"></table>
    <h3>Overall Mood</h3>
    <div id="overall" style="font-weight:bold;font-size:16px;padding:5px;"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
  <script>
  const MODEL_URL='https://justadudewhohacks.github.io/face-api.js/models/';
  const video=document.getElementById('video');
  const overlay=document.getElementById('overlay');
  const ctx=overlay.getContext('2d');
  const btnOpen=document.getElementById('btnOpen');
  const btnStart=document.getElementById('btnStart');
  const btnStop=document.getElementById('btnStop');
  const status=document.getElementById('status');
  const logDiv=document.getElementById('mood-log');
  const avgTable=document.getElementById('avg-table');
  const overallDiv=document.getElementById('overall');

  let stream=null, analyzing=false, intervalId=null;
  let moodHistory=[], avgScores={};

  async function loadModels(){
    status.textContent='Loading models...';
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL),
      faceapi.nets.faceExpressionNet.loadFromUri(MODEL_URL)
    ]);
    status.textContent='Models loaded ✔️';
    btnStart.disabled=false;
  }

  btnOpen.addEventListener('click',async()=>{
    try{
      stream=await navigator.mediaDevices.getUserMedia({video:true});
      video.srcObject=stream;
      btnOpen.disabled=true;
      status.textContent='Camera open — loading models...';
      await loadModels();
    }catch(err){alert('Camera access failed: '+err.message);}
  });

  function updateAverages(expr){
    for(const [mood,val] of Object.entries(expr)){
      avgScores[mood]=(avgScores[mood]||0)+val;
    }
  }

  function renderAvgTable(){
    const totalSamples=moodHistory.length||1;
    let rows='<tr><th>Mood</th><th>Average</th></tr>';
    for(const [mood,val] of Object.entries(avgScores)){
      rows+=`<tr><td>${mood}</td><td>${(val/totalSamples*100).toFixed(1)}%</td></tr>`;
    }
    avgTable.innerHTML=rows;
  }

  function updateOverall(){
    if(!moodHistory.length){overallDiv.textContent='—';return;}
    const last=moodHistory[moodHistory.length-1];
    const all={};
    moodHistory.forEach(m=>{
      for(const [k,v] of Object.entries(m)) all[k]=(all[k]||0)+v;
    });
    const top=Object.entries(all).sort((a,b)=>b[1]-a[1])[0][0];
    overallDiv.textContent=top;
  }

  function addLog(moodName){
    const time=new Date().toLocaleTimeString();
    const div=document.createElement('div');
    div.innerHTML=`<span class='mood-pill'>${time}: <b>${moodName}</b></span>`;
    logDiv.prepend(div);
    if(logDiv.children.length>25) logDiv.removeChild(logDiv.lastChild);
  }

  btnStart.addEventListener('click',()=>{
    if(analyzing)return;
    analyzing=true;
    btnStart.disabled=true;btnStop.disabled=false;
    status.textContent='Analyzing...';
    intervalId=setInterval(async()=>{
      const dets=await faceapi.detectAllFaces(video,new faceapi.TinyFaceDetectorOptions()).withFaceExpressions();
      if(dets.length>0){
        const expr=dets[0].expressions;
        moodHistory.push(expr);
        updateAverages(expr);
        const top=Object.entries(expr).sort((a,b)=>b[1]-a[1])[0];
        addLog(top[0]);
        renderAvgTable();
        updateOverall();
      }
    },400);
  });

  btnStop.addEventListener('click',()=>{
    analyzing=false;clearInterval(intervalId);
    btnStop.disabled=true;btnStart.disabled=false;
    status.textContent='Stopped';
  });

  window.addEventListener('beforeunload',()=>{if(stream)stream.getTracks().forEach(t=>t.stop());});
  </script>
</body>
</html>
