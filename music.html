<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Hindi Song Generator (only JS)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:system-ui,Roboto,Arial;margin:24px auto;max-width:900px;padding:0 18px;color:#111}
h1{font-size:22px;margin-bottom:6px}
textarea,input,select{width:100%;padding:8px;margin-top:6px;border:1px solid #ccc;border-radius:6px;box-sizing:border-box}
button{margin-top:12px;padding:10px 14px;border:0;border-radius:8px;font-weight:600;color:#fff;background:#0066ff}
.small{font-size:13px;color:#444}
.warn{background:#fff4e5;border:1px solid #ffd8a8;padding:10px;border-radius:8px;margin-top:12px}
</style>
</head>
<body>
<h1>üéµ Hindi Lyrics + Notes ‚Üí Song (.wav)</h1>

<div class="small">Enter Hindi lyrics and simple notes. Choose a tone, then click <b>Generate & Record</b>.  
When prompted, select <b>this tab</b> and allow audio capture.</div>

<label>Lyrics (Hindi text)</label>
<textarea id="lyrics" rows="5">‡§§‡•á‡§∞‡•Ä ‡§Æ‡•Å‡§∏‡•ç‡§ï‡§æ‡§® ‡§∏‡•á ‡§∞‡•ã‡§∂‡§® ‡§π‡•à, ‡§Ø‡•á ‡§¶‡§ø‡§≤ ‡§Æ‡•á‡§∞‡§æ‡•§
‡§π‡§∞ ‡§ß‡§°‡§º‡§ï‡§® ‡§Æ‡•á‡§Ç ‡§¨‡§∏‡§æ ‡§π‡•à ‡§®‡§æ‡§Æ ‡§§‡•á‡§∞‡§æ‡•§
‡§∏‡§™‡§®‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§Ü‡§§‡§æ ‡§π‡•à, ‡§∏‡§µ‡•á‡§∞‡§æ ‡§∏‡§æ ‡§§‡•Ç‡•§
‡§Æ‡•á‡§∞‡•Ä ‡§¶‡•Å‡§®‡§ø‡§Ø‡§æ ‡§Æ‡•á‡§Ç ‡§¨‡§∏, ‡§π‡•à ‡§™‡•ç‡§Ø‡§æ‡§∞ ‡§§‡•Ç‡•§</textarea>

<label>Notes (e.g. C4:0.5 D4:1)</label>
<textarea id="notes" rows="4">C4:0.5 D4:0.5 E4:1 G4:1
A4:0.5 G4:0.5 F4:1 E4:1
D4:0.5 E4:0.5 F4:1 G4:1
E4:1 D4:1 C4:2</textarea>

<label>Tone / Waveform</label>
<select id="waveform">
  <option value="sine">Sine (smooth)</option>
  <option value="triangle">Triangle</option>
  <option value="square">Square</option>
  <option value="sawtooth">Sawtooth</option>
</select>

<label>Tempo multiplier</label>
<input id="tempo" type="number" value="1" step="0.1">

<label>Speech rate</label>
<input id="speechRate" type="number" value="0.9" step="0.1">

<div class="warn">‚ö†Ô∏è Works best in Chrome/Edge. When asked, select <b>this tab</b> and enable audio.  
Then you‚Äôll get a <b>Download WAV</b> link.</div>

<button id="generateBtn">Generate & Record (WAV)</button>
<button id="playOnlyBtn" style="background:#2da52d">Play Only</button>

<div id="status" class="small" style="margin-top:12px"></div>
<div id="downloadArea" style="margin-top:12px"></div>

<script>
// --- helpers ---
function noteToFrequency(note){
  const m=note.match(/^([A-Ga-g])([#b]?)(-?\d+)$/); if(!m)return 0;
  let[,l,a,o]=m;l=l.toUpperCase();o=parseInt(o);
  const semis={C:0,D:2,E:4,F:5,G:7,A:9,B:11}[l];let s=semis;
  if(a=='#')s++; if(a=='b')s--;
  const midi=(o+1)*12+s; return 440*Math.pow(2,(midi-69)/12);
}
function parseNotes(txt,tempo=1){
  return txt.trim().split(/\s+/).map(p=>{
    const [n,d]=p.split(':'); let dur=parseFloat(d||1)/tempo;
    if(!dur||dur<=0)dur=1/tempo;
    if(/^r$/i.test(n)||/^rest$/i.test(n))return{freq:0,dur};
    return{freq:noteToFrequency(n),dur};
  });
}
function playNotesWithOscillator(ctx,notes,wave,dest){
  return new Promise(res=>{
    const now=ctx.currentTime+0.05; let t=now;
    const mg=ctx.createGain(); mg.gain.value=0.2; mg.connect(dest);
    for(const n of notes){
      if(n.freq>0){
        const o=ctx.createOscillator(); o.type=wave; o.frequency.setValueAtTime(n.freq,t);
        const g=ctx.createGain(); g.gain.setValueAtTime(0.0001,t);
        g.gain.exponentialRampToValueAtTime(1,t+0.02);
        g.gain.exponentialRampToValueAtTime(0.0001,t+n.dur-0.02);
        o.connect(g); g.connect(mg); o.start(t); o.stop(t+n.dur+0.05);
      }
      t+=n.dur;
    }
    setTimeout(()=>res(),(t-now)*1000+100);
  });
}
function writeStr(v,off,s){for(let i=0;i<s.length;i++)v.setUint8(off+i,s.charCodeAt(i));}
function encodeWAV(samples,rate){
  const b=new ArrayBuffer(44+samples.length*2),v=new DataView(b);
  writeStr(v,0,'RIFF');v.setUint32(4,36+samples.length*2,true);
  writeStr(v,8,'WAVE');writeStr(v,12,'fmt ');
  v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,1,true);
  v.setUint32(24,rate,true);v.setUint32(28,rate*2,true);v.setUint16(32,2,true);
  v.setUint16(34,16,true);writeStr(v,36,'data');v.setUint32(40,samples.length*2,true);
  let off=44;for(let i=0;i<samples.length;i++,off+=2){
    let s=Math.max(-1,Math.min(1,samples[i]));s=s<0?s*0x8000:s*0x7FFF;
    v.setInt16(off,s,true);
  }return v;
}
async function blobToWavAndDownload(blob){
  const buf=await blob.arrayBuffer();
  const ac=new (window.AudioContext||window.webkitAudioContext)();
  const dec=await ac.decodeAudioData(buf.slice(0));
  const len=dec.length,rate=dec.sampleRate;
  const data=new Float32Array(len);
  for(let i=0;i<len;i++){let sum=0;for(let ch=0;ch<dec.numberOfChannels;ch++)sum+=dec.getChannelData(ch)[i]||0;data[i]=sum/dec.numberOfChannels;}
  const wav=encodeWAV(data,rate);
  const wavBlob=new Blob([wav],{type:'audio/wav'});
  const url=URL.createObjectURL(wavBlob);
  const a=document.createElement('a');a.href=url;a.download='song.wav';a.textContent='‚¨áÔ∏è Download WAV';
  document.getElementById('downloadArea').innerHTML='';document.getElementById('downloadArea').appendChild(a);
  ac.close();
}

// --- main: play + record ---
async function playAndRecord({lyrics,notesText,waveform,tempo,speechRate}){
  document.getElementById('status').textContent='Setting up audio...';
  const notes=parseNotes(notesText,tempo);
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const msDest=ctx.createMediaStreamDestination();
  let audio=document.getElementById('__out'); if(!audio){audio=document.createElement('audio');audio.id='__out';audio.style.display='none';document.body.appendChild(audio);}
  audio.srcObject=msDest.stream; await ctx.resume();

  // Ask for tab capture
  document.getElementById('status').textContent='Share this tab and allow audio.';
  let cap;
  try{cap=await navigator.mediaDevices.getDisplayMedia({audio:true,video:true});}
  catch(e){document.getElementById('status').textContent='Permission denied.';return;}

  const rec=new MediaRecorder(cap,{mimeType:'audio/webm'});
  const chunks=[]; rec.ondataavailable=e=>{if(e.data.size)chunks.push(e.data);};
  const stopP=new Promise(r=>rec.onstop=r); rec.start(); await new Promise(r=>setTimeout(r,200));

  await audio.play().catch(()=>{});
  const synthP=playNotesWithOscillator(ctx,notes,waveform,msDest);
  const utt=new SpeechSynthesisUtterance(lyrics); utt.rate=speechRate; speechSynthesis.cancel(); speechSynthesis.speak(utt);
  await synthP; await new Promise(r=>setTimeout(r,700));

  rec.stop(); cap.getTracks().forEach(t=>t.stop()); await stopP;
  document.getElementById('status').textContent='Converting to WAV...';
  await blobToWavAndDownload(new Blob(chunks,{type:'audio/webm'}));
  document.getElementById('status').textContent='‚úÖ Done';
  ctx.close();
}

// --- play only ---
async function playOnly({lyrics,notesText,waveform,tempo,speechRate}){
  const notes=parseNotes(notesText,tempo);
  const ctx=new (window.AudioContext||window.webkitAudioContext)();
  const msDest=ctx.createMediaStreamDestination();
  let audio=document.getElementById('__out'); if(!audio){audio=document.createElement('audio');audio.id='__out';audio.style.display='none';document.body.appendChild(audio);}
  audio.srcObject=msDest.stream; await ctx.resume(); await audio.play().catch(()=>{});
  document.getElementById('status').textContent='Playing...';
  const synthP=playNotesWithOscillator(ctx,notes,waveform,msDest);
  const utt=new SpeechSynthesisUtterance(lyrics); utt.rate=speechRate; speechSynthesis.cancel(); speechSynthesis.speak(utt);
  await synthP; await new Promise(r=>setTimeout(r,500));
  document.getElementById('status').textContent='Finished.';
  ctx.close();
}

// --- UI ---
generateBtn.onclick=async()=>{
  downloadArea.innerHTML='';
  const p={lyrics:lyrics.value,notesText:notes.value,waveform:waveform.value,tempo:parseFloat(tempo.value)||1,speechRate:parseFloat(speechRate.value)||1};
  generateBtn.disabled=playOnlyBtn.disabled=true;
  try{await playAndRecord(p);}catch(e){status.textContent='Error: '+e;}finally{generateBtn.disabled=playOnlyBtn.disabled=false;}
};
playOnlyBtn.onclick=async()=>{
  const p={lyrics:lyrics.value,notesText:notes.value,waveform:waveform.value,tempo:parseFloat(tempo.value)||1,speechRate:parseFloat(speechRate.value)||1};
  generateBtn.disabled=playOnlyBtn.disabled=true;
  try{await playOnly(p);}catch(e){status.textContent='Error: '+e;}finally{generateBtn.disabled=playOnlyBtn.disabled=false;}
};
</script>
</body>
</html>

